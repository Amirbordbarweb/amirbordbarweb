<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            direction: rtl;
            padding: 50px;
            background-color: #f5f5f5;
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #e8f5e9;
        }
        .stats {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 400px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>ğŸŒ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª</h1>
    
    <div class="stats">
        <p>ØªØ¹Ø¯Ø§Ø¯ Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡: <span id="totalCount">0</span></p>
        <p>Ø¢Ø®Ø±ÛŒÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª: <span id="lastLocation">Ù†Ø¯Ø§Ø±Ø¯</span></p>
    </div>
    
    <button onclick="getLocation()">ğŸ“ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>
    <p id="message">Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª...</p>
    
    <p>
        <a href="show-location.html" style="color: #2196F3; text-decoration: none;">
            ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÙ…Ø§Ù… Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ â†’
        </a>
    </p>

    <script>
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        const DB_NAME = "LocationsDB";
        const DB_VERSION = 1;
        const STORE_NAME = "locations";
        let db = null;
        
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³:", event.target.error);
                    reject(event.target.error);
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø² Ø´Ø¯");
                    updateStats();
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    
                    // Ø§ÛŒØ¬Ø§Ø¯ object store Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        const store = database.createObjectStore(STORE_NAME, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        
                        // Ø§ÛŒØ¬Ø§Ø¯ Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('deviceId', 'deviceId', { unique: false });
                        
                        console.log("âœ… object store Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯");
                    }
                };
            });
        }
        
        // ØªÙˆÙ„ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }
        
        // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        async function saveLocationToDB(latitude, longitude, accuracy) {
            if (!db) await initDatabase();
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const locationData = {
                    latitude: latitude,
                    longitude: longitude,
                    accuracy: accuracy,
                    deviceId: getDeviceId(),
                    timestamp: new Date().toISOString(),
                    timestampPersian: new Date().toLocaleString('fa-IR'),
                    ip: await getIPAddress()
                };
                
                const request = store.add(locationData);
                
                request.onsuccess = () => {
                    console.log("âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
                    updateStats();
                    resolve(request.result);
                };
                
                request.onerror = (event) => {
                    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³ IP
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'Ù†Ø§Ù…Ø´Ø®Øµ';
            }
        }
        
        // Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÙ‡Ø§
        async function getTotalCount() {
            if (!db) await initDatabase();
            
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const countRequest = store.count();
                
                countRequest.onsuccess = () => {
                    resolve(countRequest.result);
                };
                
                countRequest.onerror = () => {
                    resolve(0);
                };
            });
        }
        
        // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª
        async function getLastLocation() {
            if (!db) await initDatabase();
            
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const index = store.index('timestamp');
                
                const request = index.openCursor(null, 'prev');
                let lastLocation = null;
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        lastLocation = cursor.value;
                    }
                    resolve(lastLocation);
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø±
        async function updateStats() {
            try {
                const totalCount = await getTotalCount();
                document.getElementById('totalCount').textContent = totalCount;
                
                const lastLocation = await getLastLocation();
                if (lastLocation) {
                    document.getElementById('lastLocation').textContent = 
                        `${lastLocation.latitude.toFixed(4)}, ${lastLocation.longitude.toFixed(4)}`;
                }
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø±:", error);
            }
        }
        
        // Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª
        async function getLocation() {
            const message = document.getElementById("message");
            
            if (!navigator.geolocation) {
                message.innerHTML = "Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù‚Ø§Ø¨Ù„ÛŒØª Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
                return;
            }
            
            message.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.";
            
            // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            await initDatabase();
            
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const acc = position.coords.accuracy;
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙÙˆØ±ÛŒ
                    localStorage.setItem("userLatitude", lat);
                    localStorage.setItem("userLongitude", lng);
                    localStorage.setItem("userAccuracy", acc);
                    
                    try {
                        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                        await saveLocationToDB(lat, lng, acc);
                        
                        message.innerHTML = `
                            âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!<br>
                            ğŸ“ Ù…Ø®ØªØµØ§Øª: ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                            ğŸ¯ Ø¯Ù‚Øª: ${acc.toFixed(2)} Ù…ØªØ±
                        `;
                        
                        // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ Ù†Ù…Ø§ÛŒØ´ Ù¾Ø³ Ø§Ø² 2 Ø«Ø§Ù†ÛŒÙ‡
                        setTimeout(() => {
                            window.location.href = "show-location.html";
                        }, 2000);
                        
                    } catch (error) {
                        message.innerHTML = "âš ï¸ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ Ø§Ù…Ø§ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯.";
                    }
                },
                function(error) {
                    let errorMessage;
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬ÙˆØ² Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ø²Ù…Ø§Ù†â€ŒØ¨Ø± Ø´Ø¯.";
                            break;
                        default:
                            errorMessage = "Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø±Ø® Ø¯Ø§Ø¯.";
                    }
                    message.innerHTML = "Ø®Ø·Ø§: " + errorMessage;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ ØµÙØ­Ù‡
        window.onload = async function() {
            try {
                await initDatabase();
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³:", error);
            }
        };
    </script>
</body>
</html>
